<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BoxShip - Sistema de Montagem de Caixas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#25D366',
                        secondary: '#128C7E',
                        dark: '#075E54',
                        light: '#DCF8C6',
                        accent: '#6366f1'
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');

        * {
            font-family: 'Inter', sans-serif;
        }

        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: #25D366;
            border-radius: 10px;
        }

        .tab-btn.active {
            color: #25D366;
            border-bottom-color: #25D366;
            background: rgba(37, 211, 102, 0.05);
        }

        .card-hover {
            transition: all 0.3s ease;
        }

        .card-hover:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .weight-bar {
            transition: width 0.5s ease;
        }

        .product-item {
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-gradient-to-r from-dark to-secondary text-white shadow-lg">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="bg-white/10 p-2 rounded-xl">
                        <i class="fas fa-boxes-stacked text-3xl text-primary"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold">BoxShip</h1>
                        <p class="text-sm text-gray-300">Montagem & Envio de Caixas</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="hidden md:flex items-center space-x-3 bg-white/10 rounded-full px-4 py-2">
                        <div class="flex items-center space-x-2">
                            <i class="fas fa-cube text-yellow-400"></i>
                            <span class="text-sm"><span id="header-products">0</span> produtos</span>
                        </div>
                        <div class="w-px h-4 bg-white/30"></div>
                        <div class="flex items-center space-x-2">
                            <i class="fas fa-box text-blue-400"></i>
                            <span class="text-sm"><span id="header-boxes">0</span> caixas</span>
                        </div>
                    </div>
                    <button onclick="openSettings()" class="p-2 hover:bg-white/10 rounded-full transition">
                        <i class="fas fa-cog text-xl"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="bg-white shadow-md sticky top-0 z-40">
        <div class="container mx-auto px-4">
            <div class="flex overflow-x-auto hide-scrollbar">
                <button onclick="showTab('dashboard')"
                    class="tab-btn active flex-shrink-0 px-4 md:px-6 py-4 font-medium text-gray-600 border-b-2 border-transparent transition flex items-center space-x-2"
                    data-tab="dashboard">
                    <i class="fas fa-chart-pie"></i>
                    <span class="hidden sm:inline">Dashboard</span>
                </button>
                <button onclick="showTab('clients')"
                    class="tab-btn flex-shrink-0 px-4 md:px-6 py-4 font-medium text-gray-600 border-b-2 border-transparent transition flex items-center space-x-2"
                    data-tab="clients">
                    <i class="fas fa-users"></i>
                    <span class="hidden sm:inline">Clientes</span>
                </button>
                <button onclick="showTab('receive')"
                    class="tab-btn flex-shrink-0 px-4 md:px-6 py-4 font-medium text-gray-600 border-b-2 border-transparent transition flex items-center space-x-2"
                    data-tab="receive">
                    <i class="fas fa-truck-loading"></i>
                    <span class="hidden sm:inline">Receber</span>
                </button>
                <button onclick="showTab('products')"
                    class="tab-btn flex-shrink-0 px-4 md:px-6 py-4 font-medium text-gray-600 border-b-2 border-transparent transition flex items-center space-x-2"
                    data-tab="products">
                    <i class="fas fa-cubes"></i>
                    <span class="hidden sm:inline">Produtos</span>
                </button>
                <button onclick="showTab('boxes')"
                    class="tab-btn flex-shrink-0 px-4 md:px-6 py-4 font-medium text-gray-600 border-b-2 border-transparent transition flex items-center space-x-2"
                    data-tab="boxes">
                    <i class="fas fa-box"></i>
                    <span class="hidden sm:inline">Caixas</span>
                </button>
                <button onclick="showTab('assembly')"
                    class="tab-btn flex-shrink-0 px-4 md:px-6 py-4 font-medium text-gray-600 border-b-2 border-transparent transition flex items-center space-x-2"
                    data-tab="assembly">
                    <i class="fas fa-tools"></i>
                    <span class="hidden sm:inline">Montar</span>
                </button>
                <button onclick="showTab('shipments')"
                    class="tab-btn flex-shrink-0 px-4 md:px-6 py-4 font-medium text-gray-600 border-b-2 border-transparent transition flex items-center space-x-2"
                    data-tab="shipments">
                    <i class="fas fa-shipping-fast"></i>
                    <span class="hidden sm:inline">Envios</span>
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-6">

        <!-- DASHBOARD -->
        <section id="tab-dashboard" class="tab-content">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-white rounded-2xl shadow-lg p-5 card-hover border-l-4 border-yellow-500">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-xs uppercase tracking-wide">Aguardando</p>
                            <p id="stat-pending" class="text-3xl font-bold text-gray-800 mt-1">0</p>
                        </div>
                        <div class="bg-yellow-100 p-3 rounded-xl">
                            <i class="fas fa-clock text-xl text-yellow-600"></i>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-2xl shadow-lg p-5 card-hover border-l-4 border-blue-500">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-xs uppercase tracking-wide">Em Montagem</p>
                            <p id="stat-assembling" class="text-3xl font-bold text-gray-800 mt-1">0</p>
                        </div>
                        <div class="bg-blue-100 p-3 rounded-xl">
                            <i class="fas fa-tools text-xl text-blue-600"></i>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-2xl shadow-lg p-5 card-hover border-l-4 border-primary">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-xs uppercase tracking-wide">Prontas</p>
                            <p id="stat-ready" class="text-3xl font-bold text-gray-800 mt-1">0</p>
                        </div>
                        <div class="bg-green-100 p-3 rounded-xl">
                            <i class="fas fa-check-circle text-xl text-green-600"></i>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-2xl shadow-lg p-5 card-hover border-l-4 border-purple-500">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-xs uppercase tracking-wide">Enviadas</p>
                            <p id="stat-shipped" class="text-3xl font-bold text-gray-800 mt-1">0</p>
                        </div>
                        <div class="bg-purple-100 p-3 rounded-xl">
                            <i class="fas fa-shipping-fast text-xl text-purple-600"></i>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                <div class="bg-white rounded-2xl shadow-lg p-6">
                    <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-bolt text-yellow-500 mr-2"></i>
                        A√ß√µes R√°pidas
                    </h3>
                    <div class="space-y-3">
                        <button onclick="showTab('receive')"
                            class="w-full bg-gradient-to-r from-yellow-500 to-orange-500 text-white py-3 px-4 rounded-xl hover:shadow-lg transition flex items-center justify-center space-x-2">
                            <i class="fas fa-plus-circle"></i>
                            <span>Receber Produtos</span>
                        </button>
                        <button onclick="showTab('assembly')"
                            class="w-full bg-gradient-to-r from-blue-500 to-indigo-500 text-white py-3 px-4 rounded-xl hover:shadow-lg transition flex items-center justify-center space-x-2">
                            <i class="fas fa-box-open"></i>
                            <span>Montar Nova Caixa</span>
                        </button>
                        <button onclick="showTab('boxes')"
                            class="w-full bg-gradient-to-r from-primary to-secondary text-white py-3 px-4 rounded-xl hover:shadow-lg transition flex items-center justify-center space-x-2">
                            <i class="fas fa-paper-plane"></i>
                            <span>Caixas Prontas</span>
                        </button>
                    </div>
                </div>

                <div class="lg:col-span-2 bg-white rounded-2xl shadow-lg p-6">
                    <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center justify-between">
                        <span><i class="fas fa-users text-blue-500 mr-2"></i>Clientes com Produtos Pendentes</span>
                        <span id="pending-clients-count"
                            class="bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full text-sm">0</span>
                    </h3>
                    <div id="pending-clients-list" class="space-y-3 max-h-64 overflow-y-auto">
                        <p class="text-gray-500 text-center py-8">Nenhum cliente com produtos pendentes</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-2xl shadow-lg p-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4">
                    <i class="fas fa-history text-purple-500 mr-2"></i>
                    √öltimas Caixas
                </h3>
                <div id="recent-boxes" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <p class="text-gray-500 text-center py-8 col-span-3">Nenhuma caixa criada ainda</p>
                </div>
            </div>
        </section>

        <!-- CLIENTES -->
        <section id="tab-clients" class="tab-content hidden">
            <div class="bg-white rounded-2xl shadow-lg p-6">
                <div class="flex flex-col md:flex-row md:items-center justify-between mb-6 gap-4">
                    <h2 class="text-2xl font-bold text-gray-800">
                        <i class="fas fa-users text-primary mr-2"></i>
                        Clientes
                    </h2>
                    <div class="flex flex-col sm:flex-row gap-3">
                        <div class="relative">
                            <input type="text" id="search-client" placeholder="Buscar cliente..."
                                class="w-full sm:w-64 border-2 border-gray-200 rounded-xl px-4 py-2 pl-10 focus:border-primary focus:outline-none transition"
                                oninput="filterClients()">
                            <i
                                class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                        </div>
                        <button onclick="openClientModal()"
                            class="bg-primary text-white px-6 py-2 rounded-xl hover:bg-secondary transition flex items-center justify-center space-x-2">
                            <i class="fas fa-plus"></i>
                            <span>Novo Cliente</span>
                        </button>
                    </div>
                </div>

                <div id="clients-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                </div>

                <div id="no-clients" class="hidden text-center py-12">
                    <i class="fas fa-user-plus text-6xl text-gray-300 mb-4"></i>
                    <p class="text-gray-500 text-lg">Nenhum cliente cadastrado</p>
                    <button onclick="openClientModal()" class="mt-4 text-primary hover:underline">Cadastrar primeiro
                        cliente</button>
                </div>
            </div>
        </section>

        <!-- RECEBER PRODUTOS -->
        <section id="tab-receive" class="tab-content hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white rounded-2xl shadow-lg p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                        <i class="fas fa-truck-loading text-yellow-500 mr-3"></i>
                        Receber Produto
                    </h2>
                    <form id="form-receive" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                            <select id="receive-client" required
                                class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-primary focus:outline-none transition">
                                <option value="">Selecione o cliente</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Descri√ß√£o do Produto *</label>
                            <input type="text" id="receive-description" required
                                class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-primary focus:outline-none transition"
                                placeholder="Ex: Celular iPhone 15 Pro">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Peso (kg) *</label>
                                <input type="number" id="receive-weight" required step="0.01" min="0.01"
                                    class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-primary focus:outline-none transition"
                                    placeholder="0.5">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Quantidade</label>
                                <input type="number" id="receive-quantity" value="1" min="1"
                                    class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-primary focus:outline-none transition">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">C√≥digo de Rastreio</label>
                            <input type="text" id="receive-tracking"
                                class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-primary focus:outline-none transition"
                                placeholder="Ex: BR123456789XX">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Observa√ß√µes</label>
                            <textarea id="receive-notes" rows="2"
                                class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-primary focus:outline-none transition"
                                placeholder="Observa√ß√µes..."></textarea>
                        </div>
                        <div class="flex items-center p-4 bg-blue-50 rounded-xl">
                            <input type="checkbox" id="receive-notify" class="w-5 h-5 text-primary rounded">
                            <label for="receive-notify" class="ml-3 text-sm text-gray-700">Notificar cliente sobre
                                recebimento</label>
                        </div>
                        <button type="submit"
                            class="w-full bg-gradient-to-r from-yellow-500 to-orange-500 text-white py-4 rounded-xl hover:shadow-lg transition flex items-center justify-center space-x-2 text-lg font-medium">
                            <i class="fas fa-plus-circle"></i>
                            <span>Registrar Recebimento</span>
                        </button>
                    </form>
                </div>

                <div class="bg-white rounded-2xl shadow-lg p-6">
                    <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center justify-between">
                        <span><i class="fas fa-history text-gray-500 mr-2"></i>√öltimos Recebimentos</span>
                        <span id="today-received" class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm">0
                            hoje</span>
                    </h3>
                    <div id="recent-receives" class="space-y-3 max-h-96 overflow-y-auto">
                        <p class="text-gray-500 text-center py-8">Nenhum produto recebido</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- PRODUTOS -->
        <section id="tab-products" class="tab-content hidden">
            <div class="bg-white rounded-2xl shadow-lg p-6">
                <div class="flex flex-col md:flex-row md:items-center justify-between mb-6 gap-4">
                    <h2 class="text-2xl font-bold text-gray-800">
                        <i class="fas fa-cubes text-blue-500 mr-2"></i>
                        Todos os Produtos
                    </h2>
                    <div class="flex flex-wrap gap-3">
                        <select id="filter-product-status"
                            class="border-2 border-gray-200 rounded-xl px-4 py-2 focus:border-primary focus:outline-none transition"
                            onchange="loadProducts()">
                            <option value="all">Todos os Status</option>
                            <option value="pending">Aguardando</option>
                            <option value="in_box">Em Caixa</option>
                        </select>
                        <select id="filter-product-client"
                            class="border-2 border-gray-200 rounded-xl px-4 py-2 focus:border-primary focus:outline-none transition"
                            onchange="loadProducts()">
                            <option value="all">Todos os Clientes</option>
                        </select>
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Produto</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Cliente</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Peso</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Data</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="products-table" class="divide-y divide-gray-200">
                        </tbody>
                    </table>
                </div>

                <div id="no-products" class="hidden text-center py-12">
                    <i class="fas fa-box-open text-6xl text-gray-300 mb-4"></i>
                    <p class="text-gray-500 text-lg">Nenhum produto encontrado</p>
                </div>
            </div>
        </section>

        <!-- CAIXAS -->
        <section id="tab-boxes" class="tab-content hidden">
            <div class="bg-white rounded-2xl shadow-lg p-6">
                <div class="flex flex-col md:flex-row md:items-center justify-between mb-6 gap-4">
                    <h2 class="text-2xl font-bold text-gray-800">
                        <i class="fas fa-box text-primary mr-2"></i>
                        Caixas
                    </h2>
                    <div class="flex flex-wrap gap-3">
                        <select id="filter-box-status"
                            class="border-2 border-gray-200 rounded-xl px-4 py-2 focus:border-primary focus:outline-none transition"
                            onchange="loadBoxes()">
                            <option value="all">Todos os Status</option>
                            <option value="assembling">Em Montagem</option>
                            <option value="ready">Pronta</option>
                            <option value="shipped">Enviada</option>
                            <option value="delivered">Entregue</option>
                        </select>
                        <button onclick="showTab('assembly')"
                            class="bg-primary text-white px-6 py-2 rounded-xl hover:bg-secondary transition flex items-center space-x-2">
                            <i class="fas fa-plus"></i>
                            <span>Nova Caixa</span>
                        </button>
                    </div>
                </div>

                <div id="boxes-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                </div>

                <div id="no-boxes" class="hidden text-center py-12">
                    <i class="fas fa-box-open text-6xl text-gray-300 mb-4"></i>
                    <p class="text-gray-500 text-lg">Nenhuma caixa criada</p>
                    <button onclick="showTab('assembly')" class="mt-4 text-primary hover:underline">Criar primeira
                        caixa</button>
                </div>
            </div>
        </section>

        <!-- MONTAGEM -->
        <section id="tab-assembly" class="tab-content hidden">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2 space-y-6">
                    <div class="bg-white rounded-2xl shadow-lg p-6">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">
                            <i class="fas fa-user text-blue-500 mr-2"></i>
                            Selecionar Cliente
                        </h3>
                        <select id="assembly-client"
                            class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-primary focus:outline-none transition text-lg"
                            onchange="loadClientProductsForAssembly()">
                            <option value="">Selecione um cliente</option>
                        </select>
                    </div>

                    <div class="bg-white rounded-2xl shadow-lg p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-bold text-gray-800">
                                <i class="fas fa-cubes text-yellow-500 mr-2"></i>
                                Produtos Dispon√≠veis
                            </h3>
                            <button onclick="selectAllProducts()" class="text-sm text-primary hover:underline">
                                Selecionar todos
                            </button>
                        </div>
                        <div id="available-products" class="space-y-2 max-h-96 overflow-y-auto">
                            <p class="text-gray-500 text-center py-8">Selecione um cliente para ver os produtos</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-2xl shadow-lg p-6 lg:sticky lg:top-24">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">
                        <i class="fas fa-box-open text-primary mr-2"></i>
                        Caixa em Montagem
                    </h3>

                    <div class="mb-4">
                        <div class="flex justify-between text-sm mb-2">
                            <span class="text-gray-600">Peso Total</span>
                            <span id="box-weight" class="font-bold">0.00 kg</span>
                        </div>
                        <div class="h-4 bg-gray-200 rounded-full overflow-hidden">
                            <div id="weight-bar"
                                class="weight-bar h-full bg-gradient-to-r from-primary to-secondary rounded-full"
                                style="width: 0%"></div>
                        </div>
                        <div class="flex justify-between text-xs mt-1 text-gray-500">
                            <span>0 kg</span>
                            <span id="max-weight-display">25 kg (m√°x)</span>
                        </div>
                    </div>

                    <div class="mb-4">
                        <p class="text-sm text-gray-600 mb-2">Produtos na caixa: <span id="box-items-count"
                                class="font-bold">0</span></p>
                        <div id="box-products"
                            class="space-y-2 max-h-48 overflow-y-auto border-2 border-dashed border-gray-200 rounded-xl p-3 min-h-24">
                            <p class="text-gray-400 text-sm text-center py-4">Adicione produtos √† caixa</p>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">N√∫mero da Caixa</label>
                        <div class="flex items-center space-x-2">
                            <span class="bg-gray-100 px-3 py-2 rounded-lg text-gray-600 font-medium">CX-</span>
                            <input type="text" id="box-number"
                                class="flex-1 border-2 border-gray-200 rounded-xl px-4 py-2 focus:border-primary focus:outline-none transition"
                                placeholder="0001">
                            <button onclick="generateBoxNumber()"
                                class="p-2 bg-gray-100 rounded-lg hover:bg-gray-200 transition"
                                title="Gerar autom√°tico">
                                <i class="fas fa-sync-alt text-gray-600"></i>
                            </button>
                        </div>
                    </div>

                    <div class="space-y-3">
                        <button onclick="saveBoxAsDraft()"
                            class="w-full border-2 border-gray-200 text-gray-700 py-3 rounded-xl hover:bg-gray-50 transition flex items-center justify-center space-x-2">
                            <i class="fas fa-save"></i>
                            <span>Salvar Rascunho</span>
                        </button>
                        <button onclick="closeAndNotify()" id="btn-close-box" disabled
                            class="w-full bg-gradient-to-r from-primary to-secondary text-white py-3 rounded-xl hover:shadow-lg transition flex items-center justify-center space-x-2 disabled:opacity-50 disabled:cursor-not-allowed">
                            <i class="fab fa-whatsapp"></i>
                            <span>Fechar e Notificar</span>
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- ENVIOS -->
        <section id="tab-shipments" class="tab-content hidden">
            <div class="bg-white rounded-2xl shadow-lg p-6">
                <div class="flex flex-col md:flex-row md:items-center justify-between mb-6 gap-4">
                    <h2 class="text-2xl font-bold text-gray-800">
                        <i class="fas fa-shipping-fast text-purple-500 mr-2"></i>
                        Gerenciar Envios
                    </h2>
                    <select id="filter-shipment-status"
                        class="border-2 border-gray-200 rounded-xl px-4 py-2 focus:border-primary focus:outline-none transition"
                        onchange="loadShipments()">
                        <option value="ready">Prontas p/ Envio</option>
                        <option value="shipped">Enviadas</option>
                        <option value="delivered">Entregues</option>
                        <option value="all">Todas</option>
                    </select>
                </div>

                <div id="shipments-list" class="space-y-4">
                </div>

                <div id="no-shipments" class="hidden text-center py-12">
                    <i class="fas fa-truck text-6xl text-gray-300 mb-4"></i>
                    <p class="text-gray-500 text-lg">Nenhum envio encontrado</p>
                </div>
            </div>
        </section>
    </main>

    <!-- MODAIS -->
    <!-- Modal Cliente -->
    <div id="modal-client" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between p-6 border-b sticky top-0 bg-white rounded-t-2xl">
                <h3 id="modal-client-title" class="text-xl font-bold text-gray-800">Novo Cliente</h3>
                <button onclick="closeClientModal()" class="text-gray-400 hover:text-gray-600 transition">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <form id="form-client" class="p-6 space-y-4">
                <input type="hidden" id="client-id">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nome Completo *</label>
                    <input type="text" id="client-name" required
                        class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-primary focus:outline-none transition">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Pa√≠s</label>
                    <select id="client-country"
                        class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-primary focus:outline-none transition">
                        <option value="BR">üáßüá∑ Brasil (+55)</option>
                        <option value="US">üá∫üá∏ EUA (+1)</option>
                        <option value="PT">üáµüáπ Portugal (+351)</option>
                        <option value="OTHER">üåç Outro</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">WhatsApp *</label>
                    <input type="tel" id="client-phone" required
                        class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-primary focus:outline-none transition"
                        placeholder="(11) 99999-9999">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">E-mail</label>
                    <input type="email" id="client-email"
                        class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-primary focus:outline-none transition">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Endere√ßo</label>
                    <textarea id="client-address" rows="2"
                        class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-primary focus:outline-none transition"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Observa√ß√µes</label>
                    <textarea id="client-notes" rows="2"
                        class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-primary focus:outline-none transition"></textarea>
                </div>
                <div class="flex space-x-4 pt-4">
                    <button type="button" onclick="closeClientModal()"
                        class="flex-1 border-2 border-gray-200 text-gray-600 py-3 rounded-xl hover:bg-gray-50 transition">Cancelar</button>
                    <button type="submit"
                        class="flex-1 bg-primary text-white py-3 rounded-xl hover:bg-secondary transition">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Detalhes -->
    <div id="modal-box-details" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between p-6 border-b sticky top-0 bg-white rounded-t-2xl">
                <h3 id="modal-box-title" class="text-xl font-bold text-gray-800">Detalhes</h3>
                <button onclick="closeBoxDetailsModal()" class="text-gray-400 hover:text-gray-600 transition">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div id="modal-box-content" class="p-6"></div>
        </div>
    </div>

    <!-- Modal Envio -->
    <div id="modal-shipment" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md">
            <div class="flex items-center justify-between p-6 border-b">
                <h3 class="text-xl font-bold text-gray-800">Registrar Envio</h3>
                <button onclick="closeShipmentModal()" class="text-gray-400 hover:text-gray-600 transition">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <form id="form-shipment" class="p-6 space-y-4">
                <input type="hidden" id="shipment-box-id">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">C√≥digo de Rastreio</label>
                    <input type="text" id="shipment-tracking"
                        class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-primary focus:outline-none transition">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Transportadora</label>
                    <select id="shipment-carrier"
                        class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-primary focus:outline-none transition">
                        <option value="correios">Correios</option>
                        <option value="jadlog">Jadlog</option>
                        <option value="fedex">FedEx</option>
                        <option value="dhl">DHL</option>
                        <option value="outro">Outro</option>
                    </select>
                </div>
                <div class="flex items-center p-4 bg-green-50 rounded-xl">
                    <input type="checkbox" id="shipment-notify" checked class="w-5 h-5 text-primary rounded">
                    <label for="shipment-notify" class="ml-3 text-sm text-gray-700">Notificar cliente</label>
                </div>
                <div class="flex space-x-4 pt-4">
                    <button type="button" onclick="closeShipmentModal()"
                        class="flex-1 border-2 border-gray-200 text-gray-600 py-3 rounded-xl hover:bg-gray-50 transition">Cancelar</button>
                    <button type="submit"
                        class="flex-1 bg-purple-600 text-white py-3 rounded-xl hover:bg-purple-700 transition">Confirmar
                        Envio</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Configura√ß√µes -->
    <div id="modal-settings" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between p-6 border-b sticky top-0 bg-white rounded-t-2xl">
                <h3 class="text-xl font-bold text-gray-800">‚öôÔ∏è Configura√ß√µes</h3>
                <button onclick="closeSettings()" class="text-gray-400 hover:text-gray-600 transition">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-6 space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nome da Empresa</label>
                    <input type="text" id="setting-company"
                        class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-primary focus:outline-none transition">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Peso M√°ximo por Caixa (kg)</label>
                    <input type="number" id="setting-max-weight" value="25"
                        class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-primary focus:outline-none transition">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <button onclick="exportAllData()"
                        class="border-2 border-gray-200 text-gray-700 py-3 rounded-xl hover:bg-gray-50 transition">
                        <i class="fas fa-download mr-2"></i>Exportar
                    </button>
                    <button onclick="document.getElementById('import-file').click()"
                        class="border-2 border-gray-200 text-gray-700 py-3 rounded-xl hover:bg-gray-50 transition">
                        <i class="fas fa-upload mr-2"></i>Importar
                    </button>
                    <input type="file" id="import-file" accept=".json" class="hidden" onchange="importData(event)">
                </div>
                <button onclick="saveSettings()"
                    class="w-full bg-primary text-white py-3 rounded-xl hover:bg-secondary transition">Salvar</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast"
        class="fixed bottom-4 right-4 transform translate-y-full opacity-0 transition-all duration-300 z-50">
        <div class="bg-gray-800 text-white px-6 py-4 rounded-xl shadow-lg flex items-center space-x-3">
            <i id="toast-icon" class="fas fa-check-circle text-green-400"></i>
            <span id="toast-message">Mensagem</span>
        </div>
    </div>

    <!-- ========== JAVASCRIPT COMPLETO ========== -->
    <script>
        // ==================== DATABASE ====================
        class Database {
            constructor() {
                this.dbName = 'BoxShipDB';
                this.dbVersion = 1;
                this.db = null;
            }

            async init() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, this.dbVersion);
                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => { this.db = request.result; resolve(this.db); };
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains('clients')) {
                            const store = db.createObjectStore('clients', { keyPath: 'id', autoIncrement: true });
                            store.createIndex('phone', 'phone', { unique: false });
                        }
                        if (!db.objectStoreNames.contains('products')) {
                            const store = db.createObjectStore('products', { keyPath: 'id', autoIncrement: true });
                            store.createIndex('clientId', 'clientId', { unique: false });
                            store.createIndex('status', 'status', { unique: false });
                            store.createIndex('boxId', 'boxId', { unique: false });
                        }
                        if (!db.objectStoreNames.contains('boxes')) {
                            const store = db.createObjectStore('boxes', { keyPath: 'id', autoIncrement: true });
                            store.createIndex('clientId', 'clientId', { unique: false });
                            store.createIndex('status', 'status', { unique: false });
                        }
                    };
                });
            }

            async add(storeName, data) {
                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction([storeName], 'readwrite');
                    const store = tx.objectStore(storeName);
                    data.createdAt = new Date().toISOString();
                    const request = store.add(data);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async update(storeName, data) {
                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction([storeName], 'readwrite');
                    const store = tx.objectStore(storeName);
                    data.updatedAt = new Date().toISOString();
                    const request = store.put(data);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async delete(storeName, id) {
                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction([storeName], 'readwrite');
                    const store = tx.objectStore(storeName);
                    const request = store.delete(id);
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
            }

            async get(storeName, id) {
                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction([storeName], 'readonly');
                    const store = tx.objectStore(storeName);
                    const request = store.get(id);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async getAll(storeName) {
                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction([storeName], 'readonly');
                    const store = tx.objectStore(storeName);
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async getByIndex(storeName, indexName, value) {
                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction([storeName], 'readonly');
                    const store = tx.objectStore(storeName);
                    const index = store.index(indexName);
                    const request = index.getAll(value);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            getSettings() {
                const defaults = { companyName: 'Minha Empresa', maxWeight: 25 };
                const saved = localStorage.getItem('boxship_settings');
                return saved ? { ...defaults, ...JSON.parse(saved) } : defaults;
            }

            saveSettings(settings) {
                localStorage.setItem('boxship_settings', JSON.stringify(settings));
            }

            async exportAll() {
                return {
                    exportDate: new Date().toISOString(),
                    clients: await this.getAll('clients'),
                    products: await this.getAll('products'),
                    boxes: await this.getAll('boxes'),
                    settings: this.getSettings()
                };
            }
        }

        const db = new Database();

        // ==================== WHATSAPP ====================
        function formatPhone(phone) {
            let cleaned = phone.replace(/\D/g, '');
            if (cleaned.length === 11 || cleaned.length === 10) {
                return '55' + cleaned;
            }
            return cleaned;
        }

        function isMobile() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }

        function openWhatsApp(phone, message) {
            const formattedPhone = formatPhone(phone);
            const encodedMessage = encodeURIComponent(message);
            const baseUrl = isMobile() ? 'https://api.whatsapp.com/send' : 'https://web.whatsapp.com/send';
            const url = `${baseUrl}?phone=${formattedPhone}&text=${encodedMessage}`;
            window.open(url, '_blank');
        }

        async function sendWhatsApp(clientId) {
            const client = await db.get('clients', clientId);
            const message = `Ol√°, ${client.name}! Como posso ajudar?`;
            openWhatsApp(client.phone, message);
        }

        // ==================== UTILS ====================
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toast-icon');
            const text = document.getElementById('toast-message');
            text.textContent = message;
            const icons = {
                'success': 'fa-check-circle text-green-400',
                'error': 'fa-times-circle text-red-400',
                'warning': 'fa-exclamation-circle text-yellow-400',
                'info': 'fa-info-circle text-blue-400'
            };
            icon.className = 'fas ' + (icons[type] || icons['success']);
            toast.classList.remove('translate-y-full', 'opacity-0');
            toast.classList.add('translate-y-0', 'opacity-100');
            setTimeout(() => {
                toast.classList.add('translate-y-full', 'opacity-0');
                toast.classList.remove('translate-y-0', 'opacity-100');
            }, 3000);
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            return new Date(dateString).toLocaleDateString('pt-BR');
        }

        function getBoxStatusBadge(status) {
            const badges = {
                'assembling': '<span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs">Em Montagem</span>',
                'ready': '<span class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs">Pronta</span>',
                'shipped': '<span class="bg-purple-100 text-purple-800 px-2 py-1 rounded-full text-xs">Enviada</span>',
                'delivered': '<span class="bg-gray-100 text-gray-800 px-2 py-1 rounded-full text-xs">Entregue</span>'
            };
            return badges[status] || status;
        }

        function getProductStatusBadge(status) {
            const badges = {
                'pending': '<span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full text-xs">Aguardando</span>',
                'in_box': '<span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs">Em Caixa</span>',
                'shipped': '<span class="bg-purple-100 text-purple-800 px-2 py-1 rounded-full text-xs">Enviado</span>'
            };
            return badges[status] || status;
        }

        async function generateBoxNumber() {
            const boxes = await db.getAll('boxes');
            const lastNumber = boxes.reduce((max, box) => {
                const num = parseInt((box.boxNumber || 'CX-0').replace('CX-', ''));
                return num > max ? num : max;
            }, 0);
            const newNumber = (lastNumber + 1).toString().padStart(4, '0');
            document.getElementById('box-number').value = newNumber;
            return 'CX-' + newNumber;
        }

        async function exportAllData() {
            const data = await db.exportAll();
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `boxship-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            showToast('Backup criado!');
        }

        async function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            try {
                const text = await file.text();
                const data = JSON.parse(text);
                if (!confirm('Substituir todos os dados?')) return;

                // Limpar e importar
                for (const client of (data.clients || [])) {
                    delete client.id;
                    await db.add('clients', client);
                }
                for (const product of (data.products || [])) {
                    delete product.id;
                    await db.add('products', product);
                }
                for (const box of (data.boxes || [])) {
                    delete box.id;
                    await db.add('boxes', box);
                }

                showToast('Dados importados! Recarregando...');
                setTimeout(() => location.reload(), 1500);
            } catch (error) {
                showToast('Erro ao importar: ' + error.message, 'error');
            }
            event.target.value = '';
        }

        // ==================== NAVEGA√á√ÉO ====================
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('tab-' + tabName).classList.remove('hidden');
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

            switch (tabName) {
                case 'dashboard': updateStats(); loadPendingClientsList(); loadRecentBoxes(); break;
                case 'clients': loadClients(); break;
                case 'receive': loadClientSelects(); loadRecentReceives(); break;
                case 'products': loadProducts(); break;
                case 'boxes': loadBoxes(); break;
                case 'assembly': loadClientSelects(); resetAssembly(); break;
                case 'shipments': loadShipments(); break;
            }
        }

        // ==================== ESTAT√çSTICAS ====================
        async function updateStats() {
            const products = await db.getAll('products');
            const boxes = await db.getAll('boxes');

            document.getElementById('stat-pending').textContent = products.filter(p => p.status === 'pending').length;
            document.getElementById('stat-assembling').textContent = boxes.filter(b => b.status === 'assembling').length;
            document.getElementById('stat-ready').textContent = boxes.filter(b => b.status === 'ready').length;
            document.getElementById('stat-shipped').textContent = boxes.filter(b => b.status === 'shipped' || b.status === 'delivered').length;

            document.getElementById('header-products').textContent = products.filter(p => p.status === 'pending').length;
            document.getElementById('header-boxes').textContent = boxes.filter(b => b.status === 'assembling' || b.status === 'ready').length;
        }

        // ==================== CLIENTES ====================
        function openClientModal(clientId = null) {
            document.getElementById('modal-client').classList.remove('hidden');
            document.getElementById('form-client').reset();
            document.getElementById('modal-client-title').textContent = clientId ? 'Editar Cliente' : 'Novo Cliente';
            document.getElementById('client-id').value = clientId || '';

            if (clientId) {
                db.get('clients', clientId).then(client => {
                    if (client) {
                        document.getElementById('client-name').value = client.name || '';
                        document.getElementById('client-phone').value = client.phone || '';
                        document.getElementById('client-email').value = client.email || '';
                        document.getElementById('client-address').value = client.address || '';
                        document.getElementById('client-notes').value = client.notes || '';
                        document.getElementById('client-country').value = client.country || 'BR';
                    }
                });
            }
        }

        function closeClientModal() {
            document.getElementById('modal-client').classList.add('hidden');
        }

        document.getElementById('form-client').addEventListener('submit', async function (e) {
            e.preventDefault();
            const clientId = document.getElementById('client-id').value;
            const clientData = {
                name: document.getElementById('client-name').value.trim(),
                phone: document.getElementById('client-phone').value.trim(),
                email: document.getElementById('client-email').value.trim(),
                address: document.getElementById('client-address').value.trim(),
                notes: document.getElementById('client-notes').value.trim(),
                country: document.getElementById('client-country').value
            };

            try {
                if (clientId) {
                    clientData.id = parseInt(clientId);
                    await db.update('clients', clientData);
                    showToast('Cliente atualizado!');
                } else {
                    await db.add('clients', clientData);
                    showToast('Cliente cadastrado!');
                }
                closeClientModal();
                loadClients();
                loadClientSelects();
                updateStats();
            } catch (error) {
                showToast('Erro: ' + error.message, 'error');
            }
        });

        async function loadClients() {
            const clients = await db.getAll('clients');
            const products = await db.getAll('products');
            const boxes = await db.getAll('boxes');

            const grid = document.getElementById('clients-grid');
            const noClients = document.getElementById('no-clients');

            if (clients.length === 0) {
                grid.innerHTML = '';
                noClients.classList.remove('hidden');
                return;
            }

            noClients.classList.add('hidden');

            grid.innerHTML = clients.map(client => {
                const clientProducts = products.filter(p => p.clientId === client.id && p.status === 'pending');
                const clientBoxes = boxes.filter(b => b.clientId === client.id);

                return `
                <div class="bg-white rounded-xl p-5 card-hover border border-gray-200 shadow-sm">
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex items-center space-x-3">
                            <div class="w-12 h-12 bg-gradient-to-br from-primary to-secondary rounded-full flex items-center justify-center">
                                <span class="text-white font-bold text-lg">${client.name.charAt(0).toUpperCase()}</span>
                            </div>
                            <div>
                                <h3 class="font-bold text-gray-800">${client.name}</h3>
                                <p class="text-sm text-gray-500">${client.phone}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex items-center space-x-4 mb-4 text-sm">
                        <span class="text-yellow-600"><i class="fas fa-cube mr-1"></i>${clientProducts.length}</span>
                        <span class="text-blue-600"><i class="fas fa-box mr-1"></i>${clientBoxes.length}</span>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="openClientModal(${client.id})" class="bg-blue-50 text-blue-700 py-2 rounded-lg hover:bg-blue-100 transition text-sm">
                            <i class="fas fa-edit mr-1"></i>Editar
                        </button>
                        <button onclick="sendWhatsApp(${client.id})" class="bg-green-50 text-green-700 py-2 rounded-lg hover:bg-green-100 transition text-sm">
                            <i class="fab fa-whatsapp mr-1"></i>WhatsApp
                        </button>
                        ${clientProducts.length > 0 ? `
                            <button onclick="startAssemblyForClient(${client.id})" class="bg-primary text-white py-2 rounded-lg hover:bg-secondary transition text-sm col-span-2">
                                <i class="fas fa-box mr-1"></i>Montar Caixa
                            </button>
                        ` : ''}
                        <button onclick="deleteClient(${client.id})" class="bg-red-50 text-red-700 py-2 rounded-lg hover:bg-red-100 transition text-sm ${clientProducts.length > 0 ? '' : 'col-span-2'}">
                            <i class="fas fa-trash mr-1"></i>Excluir
                        </button>
                    </div>
                </div>
            `;
            }).join('');
        }

        function filterClients() {
            const search = document.getElementById('search-client').value.toLowerCase();
            document.querySelectorAll('#clients-grid > div').forEach(card => {
                card.style.display = card.textContent.toLowerCase().includes(search) ? '' : 'none';
            });
        }

        async function deleteClient(clientId) {
            const client = await db.get('clients', clientId);
            if (!confirm(`Excluir cliente "${client.name}"?\n\nTodos os produtos e caixas ser√£o exclu√≠dos!`)) return;

            const products = await db.getByIndex('products', 'clientId', clientId);
            const boxes = await db.getByIndex('boxes', 'clientId', clientId);

            for (const p of products) await db.delete('products', p.id);
            for (const b of boxes) await db.delete('boxes', b.id);
            await db.delete('clients', clientId);

            showToast('Cliente exclu√≠do!');
            loadClients();
            updateStats();
        }

        async function loadClientSelects() {
            const clients = await db.getAll('clients');
            ['receive-client', 'assembly-client', 'filter-product-client'].forEach(id => {
                const select = document.getElementById(id);
                if (!select) return;
                const first = id === 'filter-product-client' ? '<option value="all">Todos</option>' : '<option value="">Selecione</option>';
                select.innerHTML = first + clients.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            });
        }

        async function loadPendingClientsList() {
            const products = await db.getAll('products');
            const clients = await db.getAll('clients');

            const pendingByClient = {};
            products.filter(p => p.status === 'pending').forEach(p => {
                if (!pendingByClient[p.clientId]) pendingByClient[p.clientId] = [];
                pendingByClient[p.clientId].push(p);
            });

            const list = Object.entries(pendingByClient).map(([clientId, prods]) => {
                const client = clients.find(c => c.id === parseInt(clientId));
                return client ? { client, products: prods } : null;
            }).filter(Boolean);

            document.getElementById('pending-clients-count').textContent = list.length;
            const container = document.getElementById('pending-clients-list');

            if (list.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">Nenhum cliente com produtos pendentes</p>';
                return;
            }

            container.innerHTML = list.map(({ client, products }) => {
                const totalWeight = products.reduce((sum, p) => sum + parseFloat(p.weight || 0), 0);
                return `
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-xl hover:bg-gray-100 transition">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-yellow-100 rounded-full flex items-center justify-center">
                            <span class="text-yellow-700 font-bold">${client.name.charAt(0)}</span>
                        </div>
                        <div>
                            <p class="font-medium text-gray-800">${client.name}</p>
                            <p class="text-sm text-gray-500">${products.length} produtos ‚Ä¢ ${totalWeight.toFixed(2)}kg</p>
                        </div>
                    </div>
                    <button onclick="startAssemblyForClient(${client.id})" class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-secondary transition text-sm">
                        Montar
                    </button>
                </div>
            `;
            }).join('');
        }

        // ==================== RECEBER PRODUTOS ====================
        document.getElementById('form-receive').addEventListener('submit', async function (e) {
            e.preventDefault();

            const clientId = parseInt(document.getElementById('receive-client').value);
            const quantity = parseInt(document.getElementById('receive-quantity').value) || 1;

            const productData = {
                clientId,
                description: document.getElementById('receive-description').value.trim(),
                weight: parseFloat(document.getElementById('receive-weight').value),
                tracking: document.getElementById('receive-tracking').value.trim(),
                notes: document.getElementById('receive-notes').value.trim(),
                status: 'pending',
                boxId: null,
                receivedAt: new Date().toISOString()
            };

            try {
                for (let i = 0; i < quantity; i++) {
                    await db.add('products', { ...productData });
                }

                if (document.getElementById('receive-notify').checked) {
                    const client = await db.get('clients', clientId);
                    const message = `‚úÖ Ol√°, ${client.name}!\n\nRecebemos seu produto:\nüì¶ ${productData.description}\n‚öñÔ∏è ${productData.weight}kg\n\nAssim que sua caixa estiver pronta, voc√™ ser√° notificado!`;
                    openWhatsApp(client.phone, message);
                }

                showToast(`${quantity} produto(s) registrado(s)!`);
                document.getElementById('form-receive').reset();
                loadRecentReceives();
                loadProducts();
                updateStats();
                loadPendingClientsList();
            } catch (error) {
                showToast('Erro: ' + error.message, 'error');
            }
        });

        async function loadRecentReceives() {
            const products = await db.getAll('products');
            const clients = await db.getAll('clients');
            const clientsMap = Object.fromEntries(clients.map(c => [c.id, c]));

            products.sort((a, b) => new Date(b.receivedAt) - new Date(a.receivedAt));

            const today = new Date().toDateString();
            document.getElementById('today-received').textContent = products.filter(p => new Date(p.receivedAt).toDateString() === today).length + ' hoje';

            const container = document.getElementById('recent-receives');

            if (products.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">Nenhum produto recebido</p>';
                return;
            }

            container.innerHTML = products.slice(0, 15).map(product => {
                const client = clientsMap[product.clientId];
                return `
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-xl">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-cube text-blue-600"></i>
                        </div>
                        <div>
                            <p class="font-medium text-gray-800 text-sm">${product.description}</p>
                            <p class="text-xs text-gray-500">${client?.name || 'N/A'} ‚Ä¢ ${product.weight}kg</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-xs text-gray-500">${formatDate(product.receivedAt)}</p>
                        ${getProductStatusBadge(product.status)}
                    </div>
                </div>
            `;
            }).join('');
        }

        // ==================== PRODUTOS ====================
        async function loadProducts() {
            const products = await db.getAll('products');
            const clients = await db.getAll('clients');
            const boxes = await db.getAll('boxes');

            const clientsMap = Object.fromEntries(clients.map(c => [c.id, c]));
            const boxesMap = Object.fromEntries(boxes.map(b => [b.id, b]));

            const statusFilter = document.getElementById('filter-product-status')?.value || 'all';
            const clientFilter = document.getElementById('filter-product-client')?.value || 'all';

            let filtered = products;
            if (statusFilter !== 'all') filtered = filtered.filter(p => p.status === statusFilter);
            if (clientFilter !== 'all') filtered = filtered.filter(p => p.clientId === parseInt(clientFilter));

            filtered.sort((a, b) => new Date(b.receivedAt) - new Date(a.receivedAt));

            const table = document.getElementById('products-table');
            const noProducts = document.getElementById('no-products');

            if (filtered.length === 0) {
                table.innerHTML = '';
                noProducts.classList.remove('hidden');
                return;
            }

            noProducts.classList.add('hidden');

            table.innerHTML = filtered.map(product => {
                const client = clientsMap[product.clientId];
                const box = product.boxId ? boxesMap[product.boxId] : null;

                return `
                <tr class="hover:bg-gray-50 transition">
                    <td class="px-4 py-3">
                        <p class="font-medium text-gray-800">${product.description}</p>
                        ${product.tracking ? `<p class="text-xs text-gray-500">${product.tracking}</p>` : ''}
                    </td>
                    <td class="px-4 py-3 text-sm">${client?.name || 'N/A'}</td>
                    <td class="px-4 py-3 text-sm font-medium">${product.weight} kg</td>
                    <td class="px-4 py-3 text-sm text-gray-500">${formatDate(product.receivedAt)}</td>
                    <td class="px-4 py-3">
                        ${getProductStatusBadge(product.status)}
                        ${box ? `<span class="text-xs text-gray-500 ml-1">${box.boxNumber}</span>` : ''}
                    </td>
                    <td class="px-4 py-3">
                        ${product.status === 'pending' ? `
                            <button onclick="deleteProduct(${product.id})" class="p-2 text-red-600 hover:bg-red-50 rounded-lg transition">
                                <i class="fas fa-trash"></i>
                            </button>
                        ` : ''}
                    </td>
                </tr>
            `;
            }).join('');
        }

        async function deleteProduct(productId) {
            const product = await db.get('products', productId);
            if (!confirm(`Excluir "${product.description}"?`)) return;

            await db.delete('products', productId);
            showToast('Produto exclu√≠do!');
            loadProducts();
            updateStats();
            loadPendingClientsList();
        }

        // ==================== MONTAGEM ====================
        let currentBoxProducts = [];
        let currentBoxClientId = null;

        function resetAssembly() {
            currentBoxProducts = [];
            currentBoxClientId = null;
            document.getElementById('assembly-client').value = '';
            document.getElementById('available-products').innerHTML = '<p class="text-gray-500 text-center py-8">Selecione um cliente</p>';
            document.getElementById('box-products').innerHTML = '<p class="text-gray-400 text-sm text-center py-4">Adicione produtos</p>';
            updateBoxDisplay();
            generateBoxNumber();
        }

        async function startAssemblyForClient(clientId) {
            showTab('assembly');
            document.getElementById('assembly-client').value = clientId;
            await loadClientProductsForAssembly();
        }

        async function loadClientProductsForAssembly() {
            const clientId = parseInt(document.getElementById('assembly-client').value);
            const container = document.getElementById('available-products');

            if (!clientId) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">Selecione um cliente</p>';
                currentBoxProducts = [];
                currentBoxClientId = null;
                updateBoxDisplay();
                return;
            }

            currentBoxClientId = clientId;

            const products = await db.getByIndex('products', 'clientId', clientId);
            const pendingProducts = products.filter(p => p.status === 'pending' && !currentBoxProducts.find(bp => bp.id === p.id));

            if (pendingProducts.length === 0) {
                container.innerHTML = '<p class="text-green-600 text-center py-8"><i class="fas fa-check-circle mr-2"></i>Todos adicionados ou nenhum dispon√≠vel</p>';
                return;
            }

            container.innerHTML = pendingProducts.map(product => `
            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-xl hover:bg-gray-100 transition cursor-pointer" onclick="addToBox(${product.id})">
                <div>
                    <p class="font-medium text-gray-800 text-sm">${product.description}</p>
                    <p class="text-xs text-gray-500">${formatDate(product.receivedAt)}</p>
                </div>
                <div class="flex items-center space-x-3">
                    <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-lg text-sm font-medium">${product.weight}kg</span>
                    <i class="fas fa-plus-circle text-primary text-xl"></i>
                </div>
            </div>
        `).join('');
        }

        async function addToBox(productId) {
            const settings = db.getSettings();
            const maxWeight = settings.maxWeight || 25;

            if (currentBoxProducts.find(p => p.id === productId)) {
                showToast('J√° est√° na caixa!', 'warning');
                return;
            }

            const product = await db.get('products', productId);
            const currentWeight = currentBoxProducts.reduce((sum, p) => sum + parseFloat(p.weight), 0);

            if (currentWeight + parseFloat(product.weight) > maxWeight) {
                showToast(`Excede ${maxWeight}kg!`, 'error');
                return;
            }

            currentBoxProducts.push(product);
            updateBoxDisplay();
            loadClientProductsForAssembly();
        }

        function removeFromBox(productId) {
            currentBoxProducts = currentBoxProducts.filter(p => p.id !== productId);
            updateBoxDisplay();
            loadClientProductsForAssembly();
        }

        function updateBoxDisplay() {
            const settings = db.getSettings();
            const maxWeight = settings.maxWeight || 25;
            const totalWeight = currentBoxProducts.reduce((sum, p) => sum + parseFloat(p.weight), 0);
            const percentage = (totalWeight / maxWeight) * 100;

            document.getElementById('box-weight').textContent = totalWeight.toFixed(2) + ' kg';
            document.getElementById('box-items-count').textContent = currentBoxProducts.length;
            document.getElementById('max-weight-display').textContent = maxWeight + ' kg (m√°x)';

            const weightBar = document.getElementById('weight-bar');
            weightBar.style.width = Math.min(percentage, 100) + '%';
            weightBar.className = 'weight-bar h-full rounded-full ' + (percentage > 90 ? 'bg-red-500' : percentage > 70 ? 'bg-yellow-500' : 'bg-gradient-to-r from-primary to-secondary');

            const boxContainer = document.getElementById('box-products');
            const closeBtn = document.getElementById('btn-close-box');

            if (currentBoxProducts.length === 0) {
                boxContainer.innerHTML = '<p class="text-gray-400 text-sm text-center py-4">Adicione produtos</p>';
                closeBtn.disabled = true;
            } else {
                boxContainer.innerHTML = currentBoxProducts.map(product => `
                <div class="flex items-center justify-between p-2 bg-green-50 rounded-lg">
                    <div class="flex-1">
                        <p class="text-sm font-medium text-gray-800 truncate">${product.description}</p>
                        <p class="text-xs text-gray-500">${product.weight}kg</p>
                    </div>
                    <button onclick="removeFromBox(${product.id})" class="text-red-500 hover:text-red-700 p-1">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');
                closeBtn.disabled = false;
            }
        }

        function selectAllProducts() {
            document.querySelectorAll('#available-products [onclick^="addToBox"]').forEach(el => el.click());
        }

        async function saveBoxAsDraft() {
            if (currentBoxProducts.length === 0) {
                showToast('Adicione produtos!', 'warning');
                return;
            }

            const boxNumber = 'CX-' + (document.getElementById('box-number').value || '0001');

            try {
                const boxId = await db.add('boxes', {
                    clientId: currentBoxClientId,
                    boxNumber: boxNumber,
                    status: 'assembling',
                    totalWeight: currentBoxProducts.reduce((sum, p) => sum + parseFloat(p.weight), 0),
                    productsCount: currentBoxProducts.length
                });

                for (const product of currentBoxProducts) {
                    product.status = 'in_box';
                    product.boxId = boxId;
                    await db.update('products', product);
                }

                showToast('Rascunho salvo!');
                resetAssembly();
                loadBoxes();
                updateStats();
            } catch (error) {
                showToast('Erro: ' + error.message, 'error');
            }
        }

        async function closeAndNotify() {
            if (currentBoxProducts.length === 0) {
                showToast('Adicione produtos!', 'warning');
                return;
            }

            const boxNumber = 'CX-' + (document.getElementById('box-number').value || '0001');

            try {
                const boxId = await db.add('boxes', {
                    clientId: currentBoxClientId,
                    boxNumber: boxNumber,
                    status: 'ready',
                    totalWeight: currentBoxProducts.reduce((sum, p) => sum + parseFloat(p.weight), 0),
                    productsCount: currentBoxProducts.length,
                    closedAt: new Date().toISOString()
                });

                for (const product of currentBoxProducts) {
                    product.status = 'in_box';
                    product.boxId = boxId;
                    await db.update('products', product);
                }

                const client = await db.get('clients', currentBoxClientId);
                const message = `üì¶ Ol√°, ${client.name}!\n\nSua caixa *${boxNumber}* est√° pronta!\n\nüìä Detalhes:\n‚Ä¢ ${currentBoxProducts.length} item(s)\n‚Ä¢ ${currentBoxProducts.reduce((sum, p) => sum + parseFloat(p.weight), 0).toFixed(2)}kg\n\nAguardando envio!`;
                openWhatsApp(client.phone, message);

                showToast('Caixa fechada!');
                resetAssembly();
                loadBoxes();
                updateStats();
            } catch (error) {
                showToast('Erro: ' + error.message, 'error');
            }
        }

        // ==================== CAIXAS ====================
        async function loadBoxes() {
            const boxes = await db.getAll('boxes');
            const clients = await db.getAll('clients');
            const products = await db.getAll('products');
            const clientsMap = Object.fromEntries(clients.map(c => [c.id, c]));

            const statusFilter = document.getElementById('filter-box-status')?.value || 'all';
            let filtered = statusFilter === 'all' ? boxes : boxes.filter(b => b.status === statusFilter);
            filtered.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

            const grid = document.getElementById('boxes-grid');
            const noBoxes = document.getElementById('no-boxes');

            if (filtered.length === 0) {
                grid.innerHTML = '';
                noBoxes.classList.remove('hidden');
                return;
            }

            noBoxes.classList.add('hidden');

            grid.innerHTML = filtered.map(box => {
                const client = clientsMap[box.clientId];
                return `
                <div class="bg-white rounded-xl p-5 card-hover border border-gray-200 shadow-sm">
                    <div class="flex items-center justify-between mb-3">
                        <span class="bg-primary text-white px-3 py-1 rounded-lg text-sm font-bold">${box.boxNumber}</span>
                        ${getBoxStatusBadge(box.status)}
                    </div>
                    <div class="mb-3">
                        <p class="font-medium text-gray-800">${client?.name || 'N/A'}</p>
                        <p class="text-sm text-gray-500">${client?.phone || ''}</p>
                    </div>
                    <div class="flex items-center space-x-4 mb-4 text-sm text-gray-600">
                        <span><i class="fas fa-cube mr-1"></i>${box.productsCount || 0}</span>
                        <span><i class="fas fa-weight mr-1"></i>${(box.totalWeight || 0).toFixed(1)}kg</span>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="viewBoxDetails(${box.id})" class="flex-1 bg-gray-100 text-gray-700 py-2 rounded-lg hover:bg-gray-200 transition text-sm">
                            <i class="fas fa-eye mr-1"></i>Ver
                        </button>
                        ${box.status === 'ready' ? `
                            <button onclick="openShipmentModal(${box.id})" class="flex-1 bg-purple-600 text-white py-2 rounded-lg hover:bg-purple-700 transition text-sm">
                                <i class="fas fa-shipping-fast mr-1"></i>Enviar
                            </button>
                        ` : ''}
                        ${box.status === 'shipped' ? `
                            <button onclick="confirmDelivery(${box.id})" class="flex-1 bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition text-sm">
                                <i class="fas fa-check-double mr-1"></i>Entregue
                            </button>
                        ` : ''}
                        <button onclick="deleteBox(${box.id})" class="bg-red-100 text-red-600 px-3 py-2 rounded-lg hover:bg-red-200 transition">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
            }).join('');
        }

        async function loadRecentBoxes() {
            const boxes = await db.getAll('boxes');
            const clients = await db.getAll('clients');
            const clientsMap = Object.fromEntries(clients.map(c => [c.id, c]));

            boxes.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

            const container = document.getElementById('recent-boxes');

            if (boxes.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8 col-span-3">Nenhuma caixa</p>';
                return;
            }

            container.innerHTML = boxes.slice(0, 6).map(box => {
                const client = clientsMap[box.clientId];
                return `
                <div class="bg-gray-50 rounded-xl p-4 card-hover cursor-pointer" onclick="viewBoxDetails(${box.id})">
                    <div class="flex items-center justify-between mb-2">
                        <span class="bg-primary/10 text-primary px-2 py-1 rounded text-sm font-bold">${box.boxNumber}</span>
                        ${getBoxStatusBadge(box.status)}
                    </div>
                    <p class="font-medium text-gray-800 text-sm">${client?.name || 'N/A'}</p>
                    <p class="text-xs text-gray-500">${box.productsCount || 0} itens ‚Ä¢ ${(box.totalWeight || 0).toFixed(1)}kg</p>
                </div>
            `;
            }).join('');
        }

        async function viewBoxDetails(boxId) {
            const box = await db.get('boxes', boxId);
            const client = await db.get('clients', box.clientId);
            const products = await db.getByIndex('products', 'boxId', boxId);

            document.getElementById('modal-box-title').textContent = box.boxNumber;
            document.getElementById('modal-box-content').innerHTML = `
            <div class="space-y-4">
                <div class="flex items-center justify-between">
                    ${getBoxStatusBadge(box.status)}
                    <span class="text-sm text-gray-500">${formatDate(box.createdAt)}</span>
                </div>
                <div class="bg-gray-50 rounded-xl p-4">
                    <h4 class="font-medium mb-2">Cliente</h4>
                    <p>${client?.name || 'N/A'}</p>
                    <p class="text-sm text-gray-500">${client?.phone || ''}</p>
                </div>
                <div class="grid grid-cols-2 gap-4 text-center">
                    <div class="bg-blue-50 rounded-xl p-3">
                        <p class="text-2xl font-bold text-blue-600">${products.length}</p>
                        <p class="text-xs text-blue-700">Produtos</p>
                    </div>
                    <div class="bg-green-50 rounded-xl p-3">
                        <p class="text-2xl font-bold text-green-600">${(box.totalWeight || 0).toFixed(2)}</p>
                        <p class="text-xs text-green-700">kg</p>
                    </div>
                </div>
                <div>
                    <h4 class="font-medium mb-2">Produtos</h4>
                    <div class="space-y-2 max-h-48 overflow-y-auto">
                        ${products.map(p => `
                            <div class="flex justify-between p-2 bg-gray-50 rounded-lg text-sm">
                                <span>${p.description}</span>
                                <span class="text-gray-500">${p.weight}kg</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
                ${box.tracking ? `
                    <div class="bg-purple-50 rounded-xl p-4">
                        <h4 class="font-medium mb-2">Envio</h4>
                        <p class="text-sm">Transportadora: ${box.carrier || 'N/A'}</p>
                        <p class="text-sm">Rastreio: ${box.tracking}</p>
                    </div>
                ` : ''}
                <div class="flex space-x-3">
                    ${box.status === 'ready' ? `
                        <button onclick="openShipmentModal(${box.id}); closeBoxDetailsModal();" class="flex-1 bg-purple-600 text-white py-3 rounded-xl">Enviar</button>
                    ` : ''}
                    <button onclick="sendWhatsApp(${box.clientId})" class="flex-1 bg-primary text-white py-3 rounded-xl">
                        <i class="fab fa-whatsapp mr-2"></i>WhatsApp
                    </button>
                </div>
            </div>
        `;
            document.getElementById('modal-box-details').classList.remove('hidden');
        }

        function closeBoxDetailsModal() {
            document.getElementById('modal-box-details').classList.add('hidden');
        }

        async function deleteBox(boxId) {
            const box = await db.get('boxes', boxId);
            if (!confirm(`Excluir caixa ${box.boxNumber}?`)) return;

            const products = await db.getByIndex('products', 'boxId', boxId);
            for (const product of products) {
                product.status = 'pending';
                product.boxId = null;
                await db.update('products', product);
            }

            await db.delete('boxes', boxId);
            showToast('Caixa exclu√≠da!');
            loadBoxes();
            loadProducts();
            updateStats();
        }

        // ==================== ENVIOS ====================
        function openShipmentModal(boxId) {
            document.getElementById('shipment-box-id').value = boxId;
            document.getElementById('form-shipment').reset();
            document.getElementById('shipment-notify').checked = true;
            document.getElementById('modal-shipment').classList.remove('hidden');
        }

        function closeShipmentModal() {
            document.getElementById('modal-shipment').classList.add('hidden');
        }

        document.getElementById('form-shipment').addEventListener('submit', async function (e) {
            e.preventDefault();

            const boxId = parseInt(document.getElementById('shipment-box-id').value);
            const tracking = document.getElementById('shipment-tracking').value.trim();
            const carrier = document.getElementById('shipment-carrier').value;
            const shouldNotify = document.getElementById('shipment-notify').checked;

            const box = await db.get('boxes', boxId);
            const client = await db.get('clients', box.clientId);

            box.status = 'shipped';
            box.tracking = tracking;
            box.carrier = carrier;
            box.shippedAt = new Date().toISOString();

            await db.update('boxes', box);

            const products = await db.getByIndex('products', 'boxId', boxId);
            for (const product of products) {
                product.status = 'shipped';
                await db.update('products', product);
            }

            if (shouldNotify && client) {
                const message = `üöö Ol√°, ${client.name}!\n\nSua caixa *${box.boxNumber}* foi enviada!\n\nüì¶ Transportadora: ${carrier}\nüìã Rastreio: ${tracking || 'A informar'}\n\nObrigado!`;
                openWhatsApp(client.phone, message);
            }

            closeShipmentModal();
            showToast('Envio registrado!');
            loadBoxes();
            loadShipments();
            updateStats();
        });

        async function confirmDelivery(boxId) {
            if (!confirm('Confirmar entrega?')) return;

            const box = await db.get('boxes', boxId);
            const client = await db.get('clients', box.clientId);

            box.status = 'delivered';
            box.deliveredAt = new Date().toISOString();
            await db.update('boxes', box);

            const message = `‚úÖ Ol√°, ${client.name}!\n\nSua caixa *${box.boxNumber}* foi entregue!\n\nObrigado pela prefer√™ncia! üíö`;
            openWhatsApp(client.phone, message);

            showToast('Entrega confirmada!');
            loadBoxes();
            loadShipments();
            updateStats();
        }

        async function loadShipments() {
            const boxes = await db.getAll('boxes');
            const clients = await db.getAll('clients');
            const clientsMap = Object.fromEntries(clients.map(c => [c.id, c]));

            const statusFilter = document.getElementById('filter-shipment-status')?.value || 'ready';
            let filtered = statusFilter === 'all' ? boxes : boxes.filter(b => b.status === statusFilter);
            filtered.sort((a, b) => new Date(b.updatedAt || b.createdAt) - new Date(a.updatedAt || a.createdAt));

            const list = document.getElementById('shipments-list');
            const noShipments = document.getElementById('no-shipments');

            if (filtered.length === 0) {
                list.innerHTML = '';
                noShipments.classList.remove('hidden');
                return;
            }

            noShipments.classList.add('hidden');

            list.innerHTML = filtered.map(box => {
                const client = clientsMap[box.clientId];
                return `
                <div class="bg-gray-50 rounded-xl p-5 flex flex-col md:flex-row md:items-center justify-between gap-4">
                    <div class="flex items-center space-x-4">
                        <div class="w-12 h-12 bg-primary/10 rounded-xl flex items-center justify-center">
                            <span class="text-primary font-bold">${(box.boxNumber || '').replace('CX-', '')}</span>
                        </div>
                        <div>
                            <div class="flex items-center space-x-2">
                                <span class="font-bold">${box.boxNumber}</span>
                                ${getBoxStatusBadge(box.status)}
                            </div>
                            <p class="text-sm text-gray-600">${client?.name || 'N/A'} ‚Ä¢ ${box.productsCount || 0} itens</p>
                            ${box.tracking ? `<p class="text-xs text-gray-500">${box.carrier}: ${box.tracking}</p>` : ''}
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        ${box.status === 'ready' ? `
                            <button onclick="openShipmentModal(${box.id})" class="bg-purple-600 text-white px-4 py-2 rounded-lg text-sm">Enviar</button>
                        ` : ''}
                        ${box.status === 'shipped' ? `
                            <button onclick="confirmDelivery(${box.id})" class="bg-green-600 text-white px-4 py-2 rounded-lg text-sm">Entregue</button>
                        ` : ''}
                        <button onclick="viewBoxDetails(${box.id})" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm">Ver</button>
                    </div>
                </div>
            `;
            }).join('');
        }

        // ==================== CONFIGURA√á√ïES ====================
        function openSettings() {
            const settings = db.getSettings();
            document.getElementById('setting-company').value = settings.companyName || '';
            document.getElementById('setting-max-weight').value = settings.maxWeight || 25;
            document.getElementById('modal-settings').classList.remove('hidden');
        }

        function closeSettings() {
            document.getElementById('modal-settings').classList.add('hidden');
        }

        function saveSettings() {
            const settings = {
                companyName: document.getElementById('setting-company').value,
                maxWeight: parseFloat(document.getElementById('setting-max-weight').value) || 25
            };
            db.saveSettings(settings);
            closeSettings();
            showToast('Configura√ß√µes salvas!');
        }

        // ==================== INICIALIZA√á√ÉO ====================
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await db.init();
                console.log('‚úÖ Sistema carregado!');

                await updateStats();
                await loadClients();
                await loadPendingClientsList();
                await loadRecentBoxes();
                await loadProducts();
                await loadBoxes();
                await loadShipments();
                await loadClientSelects();
                await loadRecentReceives();

            } catch (error) {
                console.error('Erro:', error);
                showToast('Erro ao carregar: ' + error.message, 'error');
            }
        });

        // Fechar modais com ESC
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeClientModal();
                closeBoxDetailsModal();
                closeShipmentModal();
                closeSettings();
            }
        });
    </script>
</body>

</html>